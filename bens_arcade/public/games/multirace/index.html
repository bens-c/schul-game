<!DOCTYPE html>
<html>
<head>
<title>Multiplayer Rennen</title>
<style>
body{background:#111;color:white;font-family:Arial;text-align:center}
canvas{background:#333;display:block;margin:auto}
#chat{height:120px;overflow:auto;border:1px solid #555;margin:5px;padding:5px}
</style>
</head>
<body>

<h1>ğŸ Multiplayer Rennen</h1>

<div id="login">
  <input id="name" placeholder="Dein Name">
  <button onclick="join()">Lobby beitreten</button>
</div>

<div id="game" style="display:none">
  <canvas id="c" width="300" height="500"></canvas>
  <div id="hud">ğŸ’° Geld: 0</div>


  <div id="chat"></div>
  <input id="msg" placeholder="Chat..." onkeydown="sendChat(event)">
</div>
<h3>ğŸ›’ Shop</h3>
<button onclick="buySpeed()">âš¡ Speed +1 (50ğŸ’°)</button>
<button onclick="buySkin()">ğŸ¨ Neues Auto (100ğŸ’°)</button>
<button onclick="buy()">ğŸ’ Spezial (10000ğŸ’°)</button>


<button onclick="goBack()">â¬… ZurÃ¼ck</button>

<script>
function goBack(){
  location.href = '../../index.html';
}
</script>


<script>

  let money = 0;
  let speed = 1;

const ws = new WebSocket(
  (location.protocol==="https:"?"wss":"ws")+"://"+location.host
);

ws.onopen = () => {
  console.log("âœ… WebSocket verbunden");
};

ws.onerror = e => {
  console.error("âŒ WebSocket Fehler", e);
};

ws.onclose = () => {
  console.log("âŒ WebSocket geschlossen");
};

const c = document.getElementById("c");
const ctx = c.getContext("2d");

let me = {x:130,y:420};
let players = {};
let cameraY = 0;

function join(){
  const n = document.getElementById("name").value;
  if(!n) return alert("Name eingeben!");
  ws.send(JSON.stringify({type:"join",name:n}));
  document.getElementById("login").style.display="none";
  document.getElementById("game").style.display="block";
}

ws.onmessage = e=>{
  const d = JSON.parse(e.data);

  if(d.type==="players") players=d.players;

  if(d.type==="chat"){
    const chat=document.getElementById("chat");
    chat.innerHTML += `<div><b>${d.name}:</b> ${d.text}</div>`;
    chat.scrollTop=9999;
    
  }
};

document.addEventListener("keydown",e=>{
  if(e.key=="ArrowUp") cameraY+=10;
  if(e.key=="ArrowDown") cameraY-=10;
  if(e.key=="ArrowLeft") me.x-=10;
  if(e.key=="ArrowRight") me.x+=10;

  ws.send(JSON.stringify({type:"move",x:me.x,y:cameraY}));
});

function sendChat(e){
  if(e.key==="Enter"){
    ws.send(JSON.stringify({
      type:"chat",
      text:e.target.value
    }));
    e.target.value="";
  }
}

setInterval(()=>{
  money += speed;
},1000);

function loop(){
  ctx.clearRect(0,0,300,500);
  document.getElementById("hud").innerText = "ğŸ’° Geld: " + money;


  // Unendliche StraÃŸe
  ctx.fillStyle="#555";
  ctx.fillRect(50,0,200,500);
  
  // Doppelte Linie in der Mitte (als visueller Effekt)
  ctx.strokeStyle="#ffff00";
  ctx.lineWidth=2;
  for(let i = 0; i < 10; i++) {
    const y = (i * 50 - cameraY % 50);
    ctx.beginPath();
    ctx.moveTo(150, y);
    ctx.lineTo(150, y + 25);
    ctx.stroke();
  }

  // Spieler (bleibt in der Mitte)
  ctx.fillStyle="red";
  ctx.fillRect(me.x, 420, 30, 50);
  ctx.fillStyle="white";
  ctx.font="12px Arial";
  ctx.fillText("Du", me.x+5, 415);

  // Andere Spieler
  for(let id in players){
    let p=players[id];
    // Ãœberspringe den eigenen Spieler
    if(p.name === document.getElementById("name").value) continue;
    
    const relativeY = p.y - cameraY + 420;
    if(relativeY > -50 && relativeY < 500) {
      ctx.fillStyle="blue";
      ctx.fillRect(p.x, relativeY, 30, 50);
      ctx.fillStyle="white";
      ctx.fillText(p.name, p.x, relativeY-5);
    }
  }

  requestAnimationFrame(loop);
}
loop();
let carColor = "red";

function buySpeed(){
  if(money >= 5){
    money += 500;
    speed += 1;
    alert("ğŸš€ Speed verbessert!");
  }else{
    alert("âŒ Zu wenig Geld!");
  }
}

function buySkin(){
  if(money >= 100){
    money -= 100;
    carColor = carColor === "red" ? "green" : "red";
    alert("ğŸ¨ Neuer Skin freigeschaltet!");
  }else{
    alert("âŒ Zu wenig Geld!");
  }
}

function buy(){
  if(money >= 10000){
    money -= 10000;
    alert("âœ… Kauf erfolgreich!");
  }else{
    alert("âŒ Zu wenig Geld!");
  }
}

</script>

</body>
</html>
