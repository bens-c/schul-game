<style>
  * { margin: 0; padding: 0; }
  body { width: 100vw; height: 100vh; overflow: hidden; }
  canvas { display: block; background: linear-gradient(to bottom, #87CEEB, #E0F6FF); }
  #backBtn {
    position: fixed;
    top: 10px;
    left: 10px;
    padding: 10px 15px;
    font-size: 16px;
    background: rgba(0,0,0,0.7);
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    z-index: 10;
  }
  #backBtn:hover {
    background: rgba(0,0,0,0.9);
  }
</style>
<button id="backBtn">← Zurück</button>
<canvas id="c"></canvas>
<script>
let playerX, playerY, score = 0;
const c = document.getElementById("c"), ctx = c.getContext("2d");
let obstacles = [];
let gameRunning = true;
let level = 1;
let obstacleSpeed = 4;
let spawnRate = 0.02;
let highScore = localStorage.getItem('runnerHighScore') ? parseInt(localStorage.getItem('runnerHighScore')) : 0;

function resizeCanvas() {
  c.width = window.innerWidth;
  c.height = window.innerHeight;
  playerX = c.width / 2 - 20;
  playerY = c.height - 60;
}
resizeCanvas();
window.addEventListener('resize', resizeCanvas);

// Tastatursteuerung
const keys = {};
document.addEventListener('keydown', (e) => keys[e.key] = true);
document.addEventListener('keyup', (e) => keys[e.key] = false);

function spawnObstacle() {
  const width = Math.random() * 40 + 30;
  const x = Math.random() * (c.width - width);
  obstacles.push({x, y: 0, width, height: 20});
}

function update() {
  // Spieler bewegen
  if(keys['ArrowLeft'] || keys['a']) playerX -= 5;
  if(keys['ArrowRight'] || keys['d']) playerX += 5;
  
  playerX = Math.max(0, Math.min(playerX, c.width - 40));
  
  // Level-Up bei 100 Punkte
  if(score >= 100 && level === 1) {
    level = 2;
    obstacleSpeed = 6;
    spawnRate = 0.03;
  }
  if(score >= 200 && level === 2) {
    level = 3;
    obstacleSpeed = 8;
    spawnRate = 0.04;
  }
  
  // Hindernisse bewegen
  for(let i = 0; i < obstacles.length; i++) {
    obstacles[i].y += obstacleSpeed;
    
    // Kollisionserkennung
    if(playerX < obstacles[i].x + obstacles[i].width &&
       playerX + 40 > obstacles[i].x &&
       playerY < obstacles[i].y + obstacles[i].height &&
       playerY + 40 > obstacles[i].y) {
      gameRunning = false;
      // Score speichern
      if(score > highScore) {
        highScore = score;
        localStorage.setItem('runnerHighScore', highScore);
      }
      sendScore();
    }
    
    // Hindernis vorbei = Punkt
    if(obstacles[i].y > playerY && !obstacles[i].scored) {
      obstacles[i].scored = true;
      score += 10;
    }
  }
  
  obstacles = obstacles.filter(o => o.y < c.height);
  
  if(Math.random() < spawnRate) spawnObstacle();
}

function draw() {
  ctx.clearRect(0, 0, c.width, c.height);
  
  // Spieler
  ctx.fillStyle = '#FF6B6B';
  ctx.fillRect(playerX, playerY, 40, 40);
  
  // Hindernisse
  ctx.fillStyle = '#4A4A4A';
  obstacles.forEach(o => {
    ctx.fillRect(o.x, o.y, o.width, o.height);
  });
  
  // Score und Level
  ctx.fillStyle = '#000';
  ctx.font = 'bold 20px Arial';
  ctx.textAlign = 'right';
  ctx.fillText('Score: ' + score, c.width - 10, 30);
  ctx.fillText('Level: ' + level, c.width - 10, 60);
  ctx.fillText('High Score: ' + highScore, c.width - 10, 90);
  ctx.textAlign = 'left';
  
  if(!gameRunning) {
    ctx.fillStyle = 'rgba(0,0,0,0.7)';
    ctx.fillRect(0, 0, c.width, c.height);
    ctx.fillStyle = '#FFF';
    ctx.font = 'bold 40px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('GAME OVER!', c.width/2, c.height/2);
    ctx.font = '20px Arial';
    ctx.fillText('Finaler Score: ' + score, c.width/2, c.height/2 + 50);
    ctx.fillText('Klick zum neu starten', c.width/2, c.height/2 + 100);
  }
}

function gameLoop() {
  if(gameRunning) {
    update();
  }
  draw();
  requestAnimationFrame(gameLoop);
}

document.onclick = () => {
  if(!gameRunning) {
    playerX = c.width / 2 - 20;
    playerY = c.height - 60;
    score = 0;
    level = 1;
    obstacleSpeed = 4;
    spawnRate = 0.02;
    obstacles = [];
    gameRunning = true;
  }
};

gameLoop();

document.getElementById('backBtn').onclick = () => {
  location.href = '../..';
};

function sendScore(){
  fetch("/score",{
    method:"POST",
    headers:{
      'Content-Type':'application/json',
      'Authorization': localStorage.token
    },
    body: JSON.stringify({game:"runner", score, highScore})
  });
}
</script>
